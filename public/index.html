<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>管理員包裹管理</title>
<style>
  #scanner { width: 300px; height: 200px; border: 1px solid #ccc; }
  #houseId { width: 100px; }
  .parcel-log { margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; }
</style>
</head>
<body>
<h2>新增包裹</h2>
<input type="text" id="houseId" placeholder="輸入戶名">
<video id="scanner"></video>
<div class="parcel-log" id="log"></div>

<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
const videoElement = document.getElementById('scanner');
const logEl = document.getElementById('log');
let scanning = false;

// 開始掃描
async function startScanner() {
  if (scanning) return;
  scanning = true;
  const devices = await codeReader.listVideoInputDevices();
  if (!devices.length) return alert("找不到相機");
  const selectedDeviceId = devices[0].deviceId;

  codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, async (result, err) => {
    if (result) {
      const parcelId = result.text.trim();
      const houseId = document.getElementById('houseId').value.trim();
      if (!houseId) return alert("請先輸入戶名");

      // 傳到後端
      try {
        const res = await fetch('/api/addParcel', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ parcelId, houseId })
        });
        const data = await res.json();
        if (data.ok) {
          logEl.innerHTML += `<div>✅ ${houseId} 已新增包裹: ${parcelId}</div>`;
          document.getElementById('houseId').value = ''; // 清空戶名欄位
        } else {
          logEl.innerHTML += `<div style="color:red;">❌ 新增失敗: ${data.error}</div>`;
        }
        logEl.scrollTop = logEl.scrollHeight;
      } catch(e) {
        logEl.innerHTML += `<div style="color:red;">❌ 網路錯誤: ${e}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
      }
    }
    if (err && !(err instanceof ZXing.NotFoundException)) {
      console.error(err);
    }
  });
}

// 啟動掃描
startScanner();
</script>
</body>
</html>
